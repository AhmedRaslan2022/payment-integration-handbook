# üß≠ Payment Gateway Integration Guide

This guide outlines the essential steps for integrating a **payment gateway**, focusing on secure, reliable, and real-time payment processing.  
It covers **Webhook (Callback URL) Registration**, **Payment Session Creation**, and **Webhook Event Handling & WebView Redirections**, along with best practices to ensure a robust implementation.

> ‚ö†Ô∏è Always review your gateway‚Äôs official documentation carefully, as request formats, signature headers, and field names can vary between providers.

---

## Step 1 ‚Äî Webhook (Callback URL) Registration

The webhook endpoint allows the payment gateway to notify you whenever a transaction‚Äôs status changes (e.g., success, failure, refund).  
Your backend must handle these notifications securely and idempotently, updating your internal order state only after verifying authenticity.

###  Setup Methods

- **Dashboard-based registration**  
  Some gateways (e.g., **MyFatoorah**) allow webhook registration directly from their admin panel.

- **API-based registration**  
  Others (e.g., **Tabby**, **Tamara**) provide API endpoints for dynamic registration.

### Example (via cURL)

```bash
curl --request POST \
--url https://api.tabby.ai/api/v1/webhooks \
--header 'Authorization: Bearer <token>' \
--header 'Content-Type: application/json' \
--header 'X-Merchant-Code: <x-merchant-code>' \
--data '{
  "url": "https://example.com/api/v1/payments/webhook",
  "header": {
    "title": "Custom-Signature-Header",
    "value": "RandomStringOrSecret"
  }
}'

```
---

#  Step 2 ‚Äî Session Creation Request

After webhook setup, your system creates a **payment session** to initialize the transaction.  
This API call prepares the order details and returns a secure **checkout URL** or **session token**, which redirects the user to the gateway‚Äôs payment page.

---

## üßæ Required Fields

Refer to your gateway‚Äôs documentation ‚Äî typical parameters include:

| Field | Description |
|--------|-------------|
| `order_reference` | Unique order ID generated by your system |
| `total_amount` | The total transaction amount |
| `currency` | The transaction currency (e.g., SAR, USD) |
| `customer` | Customer information (name, email, phone) |
| `items` | List of purchased products or services |
| `success_url` | Redirect URL after successful payment |
| `failure_url` | Redirect URL after failed payment |
| `cancel_url` | Redirect URL if the user cancels the payment |

> üí° **Note:**  
> If your business model doesn‚Äôt require certain fields (e.g., shipping for digital goods), clarify this with the payment provider:  
> ‚ÄúOur products are digital services and do not require a shipping address. Please confirm if this field can be omitted.‚Äù

---

## ‚öôÔ∏è Recommended Flow

Below is the general session-based payment flow that most gateways follow:

1. **User initiates payment**  
   ‚Üí You create a payment session via API  
   ‚Üí The user is redirected to the gateway‚Äôs checkout page.

2. **User completes payment**  
   ‚Üí The gateway redirects the user to one of the following URLs:  
   - `success_url`  
   - `failure_url`  
   - `cancel_url`

3. **Webhook fires**  
   ‚Üí The gateway sends a **server-to-server confirmation** to your registered webhook endpoint.  
   ‚Üí The backend must:
   - Respond **immediately** with `HTTP 200 OK`  
   - Validate the webhook signature (HMAC or secret key)  
   - Update the internal order state (e.g., Paid, Failed)

4. **Reconciliation / Fallback Process**  
   ‚Üí A scheduled background job (cron or queue worker) rechecks any orders still marked as ‚Äúpending.‚Äù  
   ‚Üí Calls the gateway‚Äôs **Payment Details Endpoint** to verify and correct their status if needed.

---


# Step 3 ‚Äî Handle Webhooks (Callback URLs) & WebView Redirections

After a payment is initiated, you must handle both **asynchronous webhooks** (server-to-server) and **frontend redirections** (user-facing) to ensure payment confirmation and order-status consistency.

---

## üì® Webhook Events Handling

Webhooks notify your backend in real time about key payment events, such as:

| Event | Description |
|--------|-------------|
| `payment_success` | Payment completed successfully |
| `payment_failed` | Payment attempt failed |
| `payment_expired` | Payment session expired |
| `payment_captured` | Funds successfully captured |
| `refund_processed` | Refund issued to the customer |

---

### üß© Processing Flow

1. **Respond immediately with HTTP 200 OK**  
   - This acknowledges receipt and prevents the gateway from retrying.  
   - Do not perform heavy logic in the initial response ‚Äî enqueue or background-process it instead.

2. **Validate Authenticity (HMAC / Signature Check)**  
   - The gateway signs each payload using a shared secret key.  
   - Your backend must:  
     1. Regenerate the HMAC from the raw request body.  
     2. Compare it with the signature header from the gateway.  
   - If they match, the payload is confirmed authentic and unaltered ‚Äî protecting you from spoofed or tampered requests.

3. **Extract Core Identifiers**  
   - `order_id`, `transaction_id`, and `status`.

4. **Update Your Order Record**  
   - Map gateway statuses to your internal states (e.g., *Paid*, *Failed*, *Refunded*).

5. **Log the Payload for Auditing**  
   - Store the raw JSON, signature, and timestamp for debugging or reconciliation.


# üåê Step 4 ‚Äî WebView Redirections, Best Practices & Payment Reliability

This section focuses on handling frontend redirections after checkout, implementing backend best practices, managing installment-based capture flows, and adding resilience through a circuit breaker mechanism.

---

## üåê WebView Redirections

Some payment gateways (e.g., **Tamara**, **Tabby**) redirect users to specific URLs after they complete or cancel a payment.  
You must configure these redirect URLs in both your **gateway dashboard** and your **backend configuration**.

| URL Type | Description |
|-----------|--------------|
| `success_url` | Redirect after successful payment |
| `failure_url` | Redirect after payment failure |
| `cancel_url` | Redirect when user cancels or abandons payment before completion |

### üîÅ Flow

1. User completes payment ‚Üí Gateway redirects to `success_url`, `failure_url`, or `cancel_url`.  
2. Frontend displays an appropriate confirmation, error, or cancellation screen.  
3. Frontend calls your backend to **recheck payment status** from your database or via the **gateway‚Äôs Payment Details API**.  
4. Backend confirms the latest order status to the frontend for accurate display.

> ‚ö†Ô∏è **Important:** Never rely solely on redirection for payment confirmation.  
> Redirections are user-facing only ‚Äî always validate payment success through **webhooks** or a **Payment Details API call**.

---


## üí≥ Installment Gateways ‚Äî Capturing the Payment

Some Buy Now, Pay Later (BNPL) or installment gateways (e.g., **Tabby**, **Tamara**) use a **two-step payment process**:  
Authorization first, then capture.

| Stage | Description |
|--------|-------------|
| **Authorization** | Amount is reserved on the customer‚Äôs card (no funds transferred yet). |
| **Capture** | Merchant explicitly captures (all or part of) the authorized amount after successful checkout. |

### ‚öôÔ∏è Implementation Notes

- Always capture payments using the gateway‚Äôs **Capture API**.  
- Use the `payment_id` or `transaction_id` returned from session creation or webhook.  
- For **partial captures** (e.g., partial shipments or staged billing), specify the `amount` in the API call.  
- Log every capture attempt with timestamps for traceability.
---

 ## üß† Best Practices

A strong payment integration balances security, reliability, and clarity in user experience.  
Follow these principles across all your gateway flows:

1. **Never trust frontend data**  
   - All sensitive logic (status updates, refunds, payment validation) must happen server-side.  
   - Frontend data can be manipulated using tools like *Proxyman* or *Charles Proxy*.

2. **Use idempotency**  
   - If a webhook or capture call repeats, ensure it‚Äôs processed only once using `event_id` or `transaction_id` checks.

3. **Acknowledge webhooks quickly**  
   - Always respond with `HTTP 200 OK` immediately, even if background work remains.

4. **Secure your endpoints**  
   - Enforce HTTPS, use shared secrets or signature headers, and validate HMACs on every request.

5. **Log everything**  
   - Store raw payloads, timestamps, and responses for reconciliation, debugging, and audits.
   - Visualize and debug webhook and API requests and responses using JSON Grid, a structured view that makes nested JSON data easier to read and inspect during development troubleshooting.

   

6. **Combine Webhooks + Payment Details API**  
   - Webhooks = Real-time confirmation  
   - Payment Details API = Fallback verification when webhooks fail or delay


  
